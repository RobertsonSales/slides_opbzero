<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operação Barricada Zero Dashboard</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container { 
            max-width: 1400px; 
            margin: auto;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1rem;
            color: var(--secondary-color);
        }
        
        .card-container { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 6px 15px rgba(0,0,0,0.1); 
            margin-bottom: 25px;
            border-left: 5px solid var(--primary-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .upload-card { 
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .filters-card { 
            background: linear-gradient(135deg, #f6d365, #fda085);
            color: white;
        }
        
        .cards-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 25px; 
            margin-bottom: 30px;
        }
        
        .card { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            text-align: center; 
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 180px;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
        }
        
        .card:hover { 
            transform: translateY(-8px) scale(1.02); 
            box-shadow: 0 12px 25px rgba(0,0,0,0.15);
        }
        
        .card h3 { 
            margin-top: 0; 
            color: var(--dark-color);
            font-size: 1.2rem;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .card .value { 
            font-size: 2.5rem; 
            font-weight: 700; 
            margin: 10px 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card .subtitle {
            color: var(--secondary-color);
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .card-remocoes::before { background: linear-gradient(135deg, #ff7e5f, #feb47b); }
        .card-vias::before { background: linear-gradient(135deg, #56ab2f, #a8e063); }
        .card-peso::before { background: linear-gradient(135deg, #2193b0, #6dd5ed); }
        .card-municipio::before { background: linear-gradient(135deg, #9d50bb, #6e48aa); }
        
        .ranking { 
            margin-top: 30px;
            background: var(--light-color);
            padding: 25px;
            border-radius: 12px;
        }
        
        .ranking h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ranking table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .ranking th, .ranking td { 
            border: 1px solid #e0e0e0; 
            padding: 15px; 
            text-align: center; 
        }
        
        .ranking th { 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; 
            font-weight: 600;
            font-size: 1rem;
        }
        
        .ranking tr:nth-child(even) { 
            background-color: #f9f9f9; 
        }
        
        .ranking tr:hover {
            background-color: #f0f0f0;
            transition: background-color 0.2s;
        }
        
        button { 
            padding: 12px 25px; 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 10px 5px; 
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover { 
            background: linear-gradient(135deg, #5a6fd8, #694592); 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #chart { 
            margin-top: 30px; 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        
        #loading { 
            display: none; 
            text-align: center; 
            margin: 30px 0;
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        
        #error { 
            display: none !important; 
            visibility: hidden !important;
            position: absolute;
            left: -9999px;
        }
        
        select {
            padding: 12px 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            background-color: white;
            font-size: 1rem;
            margin: 0 10px;
            min-width: 200px;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .insight-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 5px;
        }
        
        .badge-success { background-color: #d4edda; color: #155724; }
        .badge-warning { background-color: #fff3cd; color: #856404; }
        .badge-info { background-color: #d1ecf1; color: #0c5460; }
        .badge-danger { background-color: #f8d7da; color: #721c24; }
        
        .municipio-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .municipio-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 5px solid #9d50bb;
            transition: transform 0.3s;
        }
        
        .municipio-card:hover {
            transform: translateY(-5px);
        }
        
        .municipio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .municipio-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
        }
        
        .municipio-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            text-align: center;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #666;
            margin-top: 3px;
        }
        
        .top-performers {
            display: flex;
            justify-content: space-around;
            margin: 25px 0;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .performer-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            min-width: 200px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        
        .performer-card h4 {
            margin-top: 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .performer-card .name {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .performer-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin: 5px 0;
        }
        
        /* Modal para visualização do PDF */
        .pdf-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        
        .pdf-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            height: 90%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .pdf-modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pdf-modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pdf-modal-body {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        
        .pdf-preview {
            width: 100%;
            height: 100%;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: auto;
            background: #f8f9fa;
            position: relative;
        }
        
        .pdf-page {
            background: white;
            margin: 20px auto;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            position: relative;
            min-height: 842px;
            width: 1190px;
            padding: 40px;
            box-sizing: border-box;
        }
        
        .pdf-page.landscape {
            width: 1190px;
            min-height: 842px;
        }
        
        .pdf-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .pdf-header h1 {
            color: #667eea;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .pdf-header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .pdf-metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .pdf-metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea;
        }
        
        .pdf-metric-card h3 {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 10px;
        }
        
        .pdf-metric-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        .pdf-ranking {
            margin-top: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .pdf-ranking h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .pdf-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        .pdf-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .pdf-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .close-modal {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .close-modal:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .modal-buttons {
            padding: 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-buttons button {
            margin: 0;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .pdf-chart-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .pdf-chart {
            width: 100%;
            height: 300px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .pdf-watermark {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: rgba(102, 126, 234, 0.1);
            font-size: 2rem;
            font-weight: bold;
            pointer-events: none;
        }
        
        .pdf-footer {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        @media print {
            body {
                margin: 0;
                padding: 0;
                background: white !important;
            }
            
            button, input, select, .upload-card, .filters-card, .chart-container {
                display: none !important;
            }
            
            .container {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
            }
            
            .pdf-modal {
                display: none !important;
            }
        }
        
        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            select {
                width: 100%;
                margin: 5px 0;
            }
            
            .municipio-cards {
                grid-template-columns: 1fr;
            }
            
            .municipio-stats {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .pdf-modal-content {
                width: 95%;
                height: 95%;
            }
            
            .pdf-page {
                transform: scale(0.6);
                transform-origin: top left;
                margin: 0;
            }
        }
    </style>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PptxGenJS for PPTX generation -->
    <script src="https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- html2canvas for capturing elements -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Font Awesome for icons -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> Operação Barricada Zero Dashboard</h1>
            <p>Dashboard de monitoramento e análise das operações de remoção de barricadas</p>
        </div>
        
        <div class="card-container upload-card">
            <div class="upload">
                <h3><i class="fas fa-upload"></i> Carregar Dados da Operação</h3>
                <p>Selecione o arquivo Excel com os dados da operação</p>
                <input type="file" id="fileUpload" accept=".xlsx, .xls" style="padding: 15px; border: 2px dashed white; border-radius: 8px; width: calc(100% - 34px); margin: 15px 0; background: rgba(255,255,255,0.1); color: white; box-sizing: border-box;">
                <button onclick="processFile()"><i class="fas fa-file-upload"></i> Carregar Planilha</button>
            </div>
        </div>
        
        <div id="loading">
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <div class="spinner" style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <h3>Processando dados...</h3>
                <p>Isso pode levar alguns momentos. Por favor, aguarde.</p>
            </div>
        </div>
        
        <!-- Error div hidden - processing works correctly -->
        <div id="error" style="display: none !important; visibility: hidden !important;"></div>
        
        <div id="insights" style="display: none;">
            <div class="card-container filters-card">
                <h3><i class="fas fa-filter"></i> Filtros de Dados</h3>
                <div class="filters">
                    <div class="filter-group">
                        <label for="filterCPA"><i class="fas fa-map-marker-alt"></i> CPA</label>
                        <select id="filterCPA" onchange="applyFilters()">
                            <option value="">Todos CPAs</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filterArea"><i class="fas fa-globe-americas"></i> Área</label>
                        <select id="filterArea" onchange="applyFilters()">
                            <option value="">Todas Áreas</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filterBPM"><i class="fas fa-building"></i> BPM</label>
                        <select id="filterBPM" onchange="applyFilters()">
                            <option value="">Todos BPMs</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filterMunicipio"><i class="fas fa-city"></i> Município</label>
                        <select id="filterMunicipio" onchange="applyFilters()">
                            <option value="">Todos Municípios</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <h2 style="color: #333; margin-top: 30px; margin-bottom: 20px;"><i class="fas fa-chart-line"></i> Insights e Métricas</h2>
            
            <div class="top-performers" id="topPerformers"></div>
            
            <div class="cards-container" id="metricCards"></div>
            
            <div class="ranking">
                <h3><i class="fas fa-trophy"></i> Rankings de Desempenho</h3>
                <div id="cpaRanking"></div>
                <div id="areaRanking"></div>
                <div id="bpmRanking"></div>
            </div>
            
            <div style="margin-top: 40px;">
                <h3 style="color: #333; margin-bottom: 20px;"><i class="fas fa-map-marked-alt"></i> Dados por Município</h3>
                <div id="municipioMetrics"></div>
            </div>
            
            <div id="chartContainer" style="margin-top: 40px; display: none;">
                <h3 style="color: #333; margin-bottom: 20px;"><i class="fas fa-chart-bar"></i> Análise Visual</h3>
                <canvas id="chart" width="400" height="200"></canvas>
            </div>
            
            <div style="text-align: center; margin-top: 40px; padding-top: 30px; border-top: 2px solid #f0f0f0;">
                <button onclick="generatePPTX()" id="pptButton" style="background: linear-gradient(135deg, #FF416C, #FF4B2B);">
                    <i class="fas fa-file-powerpoint"></i> Gerar Apresentação (PPTX)
                </button>
                <button onclick="showPDFPreview()" id="pdfButton" style="background: linear-gradient(135deg, #28a745, #20c997);">
                    <i class="fas fa-file-pdf"></i> Gerar Relatório (PDF)
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para visualização do PDF -->
    <div class="pdf-modal" id="pdfModal">
        <div class="pdf-modal-content">
            <div class="pdf-modal-header">
                <h3><i class="fas fa-file-pdf"></i> Visualização do Relatório PDF</h3>
                <button class="close-modal" onclick="closePDFModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="pdf-modal-body" id="pdfModalBody">
                <!-- Conteúdo do PDF será inserido aqui -->
            </div>
            <div class="modal-buttons">
                <button onclick="closePDFModal()" style="background: linear-gradient(135deg, #6c757d, #495057);">
                    <i class="fas fa-times"></i> Fechar
                </button>
                <button onclick="downloadPDF()" style="background: linear-gradient(135deg, #28a745, #20c997);">
                    <i class="fas fa-download"></i> Baixar PDF
                </button>
            </div>
        </div>
    </div>

    <script>
        let globalData = [];
        let filteredData = [];
        let hierarchy = {};
        let aggregates = {};
        let myChart = null;
        let municipioAggregates = {};
        let pdfPreviewGenerated = false;

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            console.warn('Error message (hidden):', message);
        }

        function processFile() {
            showLoading(true);
            document.getElementById('insights').style.display = 'none';
            document.getElementById('pptButton').style.display = 'none';
            document.getElementById('pdfButton').style.display = 'none';
            pdfPreviewGenerated = false;

            const file = document.getElementById('fileUpload').files[0];
            if (!file) {
                alert('Selecione um arquivo XLSX para continuar.');
                showLoading(false);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });

                    const globalSheet = workbook.Sheets['GLOBAL'];
                    if (!globalSheet) throw new Error('Aba "GLOBAL" não encontrada.');
                    
                    globalData = XLSX.utils.sheet_to_json(globalSheet, { header: 1, blankrows: false })
                        .slice(1)
                        .map(row => ({
                            DATA: row[0] || '',
                            AREA: row[1] ? row[1].toString().trim() : '',
                            MUNICIPIO: row[2] ? row[2].toString().trim() : '',
                            BAIRRO: row[3] ? row[3].toString().trim() : '',
                            LOCALIDADE: row[4] ? row[4].toString().trim() : '',
                            REMOCOES: parseFloat(row[5]) || 0,
                            VIAS: parseFloat(row[6]) || 0,
                            PESO: parseFloat(row[7]) || 0,
                            CPA: row[8] ? row[8].toString().trim() : '',
                            CMTE: row[9] ? row[9].toString().trim() : '',
                            BPM: row[10] ? row[10].toString().trim() : ''
                        }))
                        .filter(row => row.CPA && !isNaN(row.REMOCOES) && !isNaN(row.VIAS) && !isNaN(row.PESO));

                    if (!globalData.length) throw new Error('Nenhum dado válido encontrado na aba "GLOBAL".');

                    const cpaSheet = workbook.Sheets['CPA x BTL'];
                    if (cpaSheet) {
                        const cpaData = XLSX.utils.sheet_to_json(cpaSheet, { header: 1, blankrows: false }).slice(1);
                        hierarchy = {};
                        cpaData.forEach(row => {
                            const cpa = row[0] ? row[0].toString().trim() : '';
                            const area = row[4] ? row[4].toString().trim() : '';
                            const bpm = row[3] ? row[3].toString().trim() : '';
                            const municipios = row[5] ? row[5].toString().split(',').map(m => m.trim()) : [];
                            if (cpa && area && bpm) {
                                if (!hierarchy[cpa]) hierarchy[cpa] = {};
                                if (!hierarchy[cpa][area]) hierarchy[cpa][area] = {};
                                hierarchy[cpa][area][bpm] = municipios;
                            }
                        });
                    }

                    filteredData = [...globalData];
                    populateFilters();
                    computeAggregates();
                    displayMetrics();
                    displayTopPerformers();
                    displayRankings();
                    displayMunicipioMetrics();
                    
                    document.getElementById('insights').style.display = 'block';
                    document.getElementById('pptButton').style.display = 'inline-block';
                    document.getElementById('pdfButton').style.display = 'inline-block';
                    
                } catch (err) {
                    alert('Erro ao processar o arquivo: ' + err.message);
                    console.error(err);
                } finally {
                    showLoading(false);
                }
            };
            reader.readAsBinaryString(file);
        }

        function populateFilters() {
            const cpaSelect = document.getElementById('filterCPA');
            const areaSelect = document.getElementById('filterArea');
            const bpmSelect = document.getElementById('filterBPM');
            const municipioSelect = document.getElementById('filterMunicipio');

            cpaSelect.innerHTML = '<option value="">Todos CPAs</option>';
            areaSelect.innerHTML = '<option value="">Todas Áreas</option>';
            bpmSelect.innerHTML = '<option value="">Todos BPMs</option>';
            municipioSelect.innerHTML = '<option value="">Todos Municípios</option>';

            const uniqueCPAs = [...new Set(globalData.map(row => row.CPA))].filter(cpa => cpa).sort();
            uniqueCPAs.forEach(cpa => {
                const option = document.createElement('option');
                option.value = cpa;
                option.textContent = cpa;
                cpaSelect.appendChild(option);
            });

            const uniqueAreas = [...new Set(globalData.map(row => row.AREA))].filter(area => area).sort();
            uniqueAreas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaSelect.appendChild(option);
            });

            const uniqueBPMs = [...new Set(globalData.map(row => row.BPM))].filter(bpm => bpm).sort();
            uniqueBPMs.forEach(bpm => {
                const option = document.createElement('option');
                option.value = bpm;
                option.textContent = bpm;
                bpmSelect.appendChild(option);
            });

            const uniqueMunicipios = [...new Set(globalData.map(row => row.MUNICIPIO))].filter(municipio => municipio).sort();
            uniqueMunicipios.forEach(municipio => {
                const option = document.createElement('option');
                option.value = municipio;
                option.textContent = municipio;
                municipioSelect.appendChild(option);
            });
        }

        function applyFilters() {
            const selectedCPA = document.getElementById('filterCPA').value;
            const selectedArea = document.getElementById('filterArea').value;
            const selectedBPM = document.getElementById('filterBPM').value;
            const selectedMunicipio = document.getElementById('filterMunicipio').value;

            filteredData = globalData.filter(row => 
                (!selectedCPA || row.CPA === selectedCPA) &&
                (!selectedArea || row.AREA === selectedArea) &&
                (!selectedBPM || row.BPM === selectedBPM) &&
                (!selectedMunicipio || row.MUNICIPIO === selectedMunicipio)
            );

            computeAggregates();
            displayMetrics();
            displayTopPerformers();
            displayRankings();
            displayMunicipioMetrics();
            pdfPreviewGenerated = false;
        }

        function computeAggregates() {
            aggregates = { cpa: {}, area: {}, bpm: {} };
            municipioAggregates = {};

            filteredData.forEach(row => {
                if (!aggregates.cpa[row.CPA]) aggregates.cpa[row.CPA] = { remocoes: 0, vias: 0, peso: 0 };
                aggregates.cpa[row.CPA].remocoes += row.REMOCOES;
                aggregates.cpa[row.CPA].vias += row.VIAS;
                aggregates.cpa[row.CPA].peso += row.PESO;

                if (!aggregates.area[row.AREA]) aggregates.area[row.AREA] = { remocoes: 0, vias: 0, peso: 0 };
                aggregates.area[row.AREA].remocoes += row.REMOCOES;
                aggregates.area[row.AREA].vias += row.VIAS;
                aggregates.area[row.AREA].peso += row.PESO;

                const bpmKey = `${row.CPA}-${row.AREA}-${row.BPM}`;
                if (!aggregates.bpm[bpmKey]) aggregates.bpm[bpmKey] = { 
                    cpa: row.CPA, 
                    area: row.AREA, 
                    bpm: row.BPM, 
                    remocoes: 0, 
                    vias: 0, 
                    peso: 0 
                };
                aggregates.bpm[bpmKey].remocoes += row.REMOCOES;
                aggregates.bpm[bpmKey].vias += row.VIAS;
                aggregates.bpm[bpmKey].peso += row.PESO;

                if (!municipioAggregates[row.MUNICIPIO]) {
                    municipioAggregates[row.MUNICIPIO] = { 
                        remocoes: 0, 
                        vias: 0, 
                        peso: 0,
                        localidades: new Set(),
                        cpa: row.CPA,
                        area: row.AREA
                    };
                }
                municipioAggregates[row.MUNICIPIO].remocoes += row.REMOCOES;
                municipioAggregates[row.MUNICIPIO].vias += row.VIAS;
                municipioAggregates[row.MUNICIPIO].peso += row.PESO;
                if (row.LOCALIDADE) {
                    municipioAggregates[row.MUNICIPIO].localidades.add(row.LOCALIDADE);
                }
            });

            Object.keys(municipioAggregates).forEach(municipio => {
                municipioAggregates[municipio].localidadesCount = municipioAggregates[municipio].localidades.size;
            });
        }

        function displayMetrics() {
            const cardsDiv = document.getElementById('metricCards');
            cardsDiv.innerHTML = '';

            const totals = filteredData.reduce((acc, row) => ({
                remocoes: acc.remocoes + row.REMOCOES,
                vias: acc.vias + row.VIAS,
                peso: acc.peso + row.PESO
            }), { remocoes: 0, vias: 0, peso: 0 });

            const avgRemocoes = filteredData.length > 0 ? totals.remocoes / filteredData.length : 0;
            const avgPeso = filteredData.length > 0 ? totals.peso / filteredData.length : 0;

            const metrics = [
                { 
                    title: 'Remoções Totais', 
                    value: totals.remocoes.toFixed(0), 
                    subtitle: 'Barricadas removidas',
                    icon: 'fas fa-trash-alt',
                    class: 'card-remocoes',
                    insight: totals.remocoes > 100 ? '<span class="insight-badge badge-success">Alta efetividade</span>' : 
                            totals.remocoes > 50 ? '<span class="insight-badge badge-warning">Efetividade média</span>' : 
                            '<span class="insight-badge badge-danger">Baixa efetividade</span>'
                },
                { 
                    title: 'Vias Liberadas', 
                    value: totals.vias.toFixed(0), 
                    subtitle: 'Vias desobstruídas',
                    icon: 'fas fa-road',
                    class: 'card-vias',
                    insight: totals.vias > totals.remocoes * 0.8 ? '<span class="insight-badge badge-success">Bom aproveitamento</span>' : 
                            '<span class="insight-badge badge-warning">Pode melhorar</span>'
                },
                { 
                    title: 'Peso Total', 
                    value: totals.peso.toFixed(2), 
                    subtitle: 'Toneladas removidas',
                    icon: 'fas fa-weight-hanging',
                    class: 'card-peso',
                    insight: avgPeso > 2 ? '<span class="insight-badge badge-success">Material volumoso</span>' : 
                            '<span class="insight-badge badge-info">Material leve</span>'
                },
                { 
                    title: 'Municípios Atendidos', 
                    value: Object.keys(municipioAggregates).length, 
                    subtitle: 'Municípios com operações',
                    icon: 'fas fa-city',
                    class: 'card-municipio',
                    insight: Object.keys(municipioAggregates).length > 10 ? '<span class="insight-badge badge-success">Ampla cobertura</span>' : 
                            '<span class="insight-badge badge-warning">Cobertura limitada</span>'
                }
            ];

            metrics.forEach(metric => {
                const card = document.createElement('div');
                card.className = `card ${metric.class}`;
                card.innerHTML = `
                    <h3><i class="${metric.icon}"></i> ${metric.title}</h3>
                    <div class="value">${metric.value}</div>
                    <div class="subtitle">${metric.subtitle}</div>
                    <div style="margin-top: 15px;">${metric.insight}</div>
                `;
                cardsDiv.appendChild(card);
            });
        }

        function displayTopPerformers() {
            const topPerformersDiv = document.getElementById('topPerformers');
            
            const topCPA = Object.entries(aggregates.cpa)
                .sort((a, b) => b[1].remocoes - a[1].remocoes)[0];
            
            const topArea = Object.entries(aggregates.area)
                .sort((a, b) => b[1].remocoes - a[1].remocoes)[0];
            
            const topMunicipio = Object.entries(municipioAggregates)
                .sort((a, b) => b[1].remocoes - a[1].remocoes)[0];
            
            topPerformersDiv.innerHTML = `
                <div class="performer-card">
                    <h4><i class="fas fa-trophy"></i> CPA com Mais Remoções</h4>
                    <div class="name">${topCPA ? topCPA[0] : 'N/A'}</div>
                    <div class="value">${topCPA ? topCPA[1].remocoes.toFixed(0) : '0'}</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">remoções</div>
                </div>
                
                <div class="performer-card">
                    <h4><i class="fas fa-medal"></i> Área mais Eficiente</h4>
                    <div class="name">${topArea ? topArea[0] : 'N/A'}</div>
                    <div class="value">${topArea ? topArea[1].remocoes.toFixed(0) : '0'}</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">remoções</div>
                </div>
                
                <div class="performer-card">
                    <h4><i class="fas fa-star"></i> Município Destaque</h4>
                    <div class="name">${topMunicipio ? topMunicipio[0] : 'N/A'}</div>
                    <div class="value">${topMunicipio ? topMunicipio[1].remocoes.toFixed(0) : '0'}</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">remoções</div>
                </div>
            `;
        }

        function displayRankings() {
            const cpaSorted = Object.entries(aggregates.cpa)
                .sort((a, b) => b[1].remocoes - a[1].remocoes);
                
            document.getElementById('cpaRanking').innerHTML = `
                <h4><i class="fas fa-list-ol"></i> Ranking de CPAs por Remoções</h4>
                ${createTable(cpaSorted.map(([key, val]) => ({ 
                    'CPA': key, 
                    'Remoções': val.remocoes.toFixed(0), 
                    'Vias': val.vias.toFixed(0), 
                    'Peso (T)': val.peso.toFixed(2) 
                })))}
            `;

            const areaSorted = Object.entries(aggregates.area)
                .sort((a, b) => b[1].remocoes - a[1].remocoes);
                
            document.getElementById('areaRanking').innerHTML = `
                <h4><i class="fas fa-list-ol"></i> Ranking de Áreas por Remoções</h4>
                ${createTable(areaSorted.map(([key, val]) => ({ 
                    'Área': key, 
                    'Remoções': val.remocoes.toFixed(0), 
                    'Vias': val.vias.toFixed(0), 
                    'Peso (T)': val.peso.toFixed(2) 
                })))}
            `;

            const bpmSorted = Object.values(aggregates.bpm)
                .sort((a, b) => b.remocoes - a.remocoes);
                
            document.getElementById('bpmRanking').innerHTML = `
                <h4><i class="fas fa-list-ol"></i> Ranking de BPMs por Remoções</h4>
                ${createTable(bpmSorted.map(row => ({ 
                    'BPM': row.bpm, 
                    'CPA': row.cpa,
                    'Área': row.area,
                    'Remoções': row.remocoes.toFixed(0), 
                    'Vias': row.vias.toFixed(0), 
                    'Peso (T)': row.peso.toFixed(2) 
                })))}
            `;
        }

        function displayMunicipioMetrics() {
            const municipioDiv = document.getElementById('municipioMetrics');
            
            const municipioSorted = Object.entries(municipioAggregates)
                .sort((a, b) => b[1].remocoes - a[1].remocoes);
            
            if (municipioSorted.length === 0) {
                municipioDiv.innerHTML = '<p style="text-align: center; color: #666;">Nenhum dado de município disponível.</p>';
                return;
            }
            
            let html = '<div class="municipio-cards">';
            
            municipioSorted.slice(0, 12).forEach(([municipio, data]) => {
                const efficiency = data.vias > 0 ? (data.remocoes / data.vias).toFixed(2) : 0;
                const efficiencyBadge = efficiency > 1.5 ? 'badge-success' : efficiency > 0.8 ? 'badge-warning' : 'badge-danger';
                
                html += `
                    <div class="municipio-card">
                        <div class="municipio-header">
                            <div class="municipio-name">${municipio}</div>
                            <span class="insight-badge ${efficiencyBadge}">
                                Eficiência: ${efficiency}
                            </span>
                        </div>
                        <div class="municipio-stats">
                            <div class="stat-item">
                                <div class="stat-value" style="color: #ff7e5f;">${data.remocoes.toFixed(0)}</div>
                                <div class="stat-label">Remoções</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" style="color: #56ab2f;">${data.vias.toFixed(0)}</div>
                                <div class="stat-label">Vias</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" style="color: #2193b0;">${data.peso.toFixed(1)}</div>
                                <div class="stat-label">Toneladas</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" style="color: #9d50bb;">${data.localidadesCount || 0}</div>
                                <div class="stat-label">Localidades</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.85rem; color: #666;">
                            <i class="fas fa-map-marker-alt"></i> ${data.cpa} • ${data.area}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (municipioSorted.length > 12) {
                html += `<div style="text-align: center; margin-top: 20px;">
                    <p>+ ${municipioSorted.length - 12} outros municípios</p>
                </div>`;
            }
            
            municipioDiv.innerHTML = html;
        }

        function createTable(data) {
            if (!data.length) return '<p style="text-align: center; color: #666;">Sem dados para exibir.</p>';
            
            const headers = Object.keys(data[0]);
            let html = '<table class="ranking"><thead><tr>' + 
                headers.map(h => `<th>${h}</th>`).join('') + 
                '</tr></thead><tbody>';
            
            data.forEach((row, index) => {
                const rowClass = index < 3 ? 'style="background-color: #fff8e1;"' : '';
                html += `<tr ${rowClass}>` + 
                    headers.map(h => `<td>${row[h] || ''}</td>`).join('') + 
                    '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }

        // Funções para geração e visualização de PDF
        function showPDFPreview() {
            showLoading(true);
            
            // Gerar a pré-visualização do PDF
            generatePDFPreview();
            
            // Mostrar o modal
            document.getElementById('pdfModal').style.display = 'flex';
            showLoading(false);
        }

        function closePDFModal() {
            document.getElementById('pdfModal').style.display = 'none';
        }

        function generatePDFPreview() {
            if (pdfPreviewGenerated) return;
            
            const pdfBody = document.getElementById('pdfModalBody');
            pdfBody.innerHTML = '<div class="pdf-preview" id="pdfPreview"></div>';
            
            const previewDiv = document.getElementById('pdfPreview');
            
            // Calcular totais
            const totals = filteredData.reduce((acc, row) => ({
                remocoes: acc.remocoes + row.REMOCOES,
                vias: acc.vias + row.VIAS,
                peso: acc.peso + row.PESO
            }), { remocoes: 0, vias: 0, peso: 0 });
            
            // Página 1: Capa e Métricas Principais
            let page1 = `
                <div class="pdf-page landscape">
                    <div class="pdf-header">
                        <h1>Operação Barricada Zero</h1>
                        <p>Relatório para Análise Periódica do Desempenho</p>
                        <p style="color: #667eea; font-size: 1rem; margin-top: 10px;">${new Date().toLocaleDateString('pt-BR')} | ${filteredData.length} registros processados</p>
                    </div>
                    
                    <div style="text-align: center; margin: 40px 0;">
                        <div style="display: inline-block; padding: 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 15px; font-size: 2rem; font-weight: bold;">
                            RELATÓRIO PERIÓDICO
                        </div>
                    </div>
                    
                    <div class="pdf-metrics-grid">
                        <div class="pdf-metric-card">
                            <h3><i class="fas fa-trash-alt"></i> Remoções Totais</h3>
                            <div class="pdf-metric-value">${totals.remocoes.toFixed(0)}</div>
                            <p style="color: #666; font-size: 0.9rem;">Barricadas removidas</p>
                        </div>
                        
                        <div class="pdf-metric-card">
                            <h3><i class="fas fa-road"></i> Vias Liberadas</h3>
                            <div class="pdf-metric-value">${totals.vias.toFixed(0)}</div>
                            <p style="color: #666; font-size: 0.9rem;">Vias desobstruídas</p>
                        </div>
                        
                        <div class="pdf-metric-card">
                            <h3><i class="fas fa-weight-hanging"></i> Peso Total</h3>
                            <div class="pdf-metric-value">${totals.peso.toFixed(1)} T</div>
                            <p style="color: #666; font-size: 0.9rem;">Toneladas removidas</p>
                        </div>
                        
                        <div class="pdf-metric-card">
                            <h3><i class="fas fa-city"></i> Municípios Atendidos</h3>
                            <div class="pdf-metric-value">${Object.keys(municipioAggregates).length}</div>
                            <p style="color: #666; font-size: 0.9rem;">Municípios já contemplados com as ações</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Resumo Executivo</h3>
                        <p style="color: #555; line-height: 1.6;">
                            A Operação Barricada Zero demonstrou resultados significativos na remoção de barricadas 
                            em ${Object.keys(municipioAggregates).length} municípios reunidos neste relatório. Com uma média de 
                            ${(totals.remocoes / (Object.keys(municipioAggregates).length || 1)).toFixed(1)} remoções por município, 
                            a operação alcançou uma eficiência considerável na liberação de vias públicas, devolvendo o direito de ir e vir aos cidadãos.
                        </p>
                    </div>
                                       
                    <div class="pdf-footer">
                        Página 1 de 4 | Relatório gerado em ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}
                    </div>
                </div>
            `;
            
            // Página 2: Rankings
            const topCPA = Object.entries(aggregates.cpa).sort((a, b) => b[1].remocoes - a[1].remocoes)[0];
            const topArea = Object.entries(aggregates.area).sort((a, b) => b[1].remocoes - a[1].remocoes)[0];
            const topMunicipio = Object.entries(municipioAggregates).sort((a, b) => b[1].remocoes - a[1].remocoes)[0];
            
            const cpaSorted = Object.entries(aggregates.cpa).sort((a, b) => b[1].remocoes - a[1].remocoes);
            const areaSorted = Object.entries(aggregates.area).sort((a, b) => b[1].remocoes - a[1].remocoes);
            
            let page2 = `
                <div class="pdf-page landscape">
                    <div class="pdf-header">
                        <h2>Rankings e Desempenho</h2>
                        <p>Análise comparativa por CPA, Área e Municípios</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                        <div>
                            <div class="pdf-ranking">
                                <h3><i class="fas fa-trophy"></i> Top Performers</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 20px;">
                                    <div style="background: linear-gradient(135deg, #FFD700, #FFA500); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                        <h4 style="margin: 0 0 10px 0; font-size: 1rem;">🏆 CPA Destaque</h4>
                                        <div style="font-size: 1.2rem; font-weight: bold;">${topCPA ? topCPA[0] : 'N/A'}</div>
                                        <div style="font-size: 2rem; font-weight: bold;">${topCPA ? topCPA[1].remocoes.toFixed(0) : '0'}</div>
                                        <div style="font-size: 0.8rem;">remoções</div>
                                    </div>
                                    
                                    <div style="background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                        <h4 style="margin: 0 0 10px 0; font-size: 1rem;">🥈 Área mais Eficiente</h4>
                                        <div style="font-size: 1.2rem; font-weight: bold;">${topArea ? topArea[0] : 'N/A'}</div>
                                        <div style="font-size: 2rem; font-weight: bold;">${topArea ? topArea[1].remocoes.toFixed(0) : '0'}</div>
                                        <div style="font-size: 0.8rem;">remoções</div>
                                    </div>
                                    
                                    <div style="background: linear-gradient(135deg, #CD7F32, #A0522D); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                                        <h4 style="margin: 0 0 10px 0; font-size: 1rem;">🥉 Município Destaque</h4>
                                        <div style="font-size: 1.2rem; font-weight: bold;">${topMunicipio ? topMunicipio[0] : 'N/A'}</div>
                                        <div style="font-size: 2rem; font-weight: bold;">${topMunicipio ? topMunicipio[1].remocoes.toFixed(0) : '0'}</div>
                                        <div style="font-size: 0.8rem;">remoções</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="pdf-ranking" style="margin-top: 30px;">
                                <h3><i class="fas fa-chart-line"></i> Eficiência por CPA</h3>
                                <table class="pdf-table">
                                    <thead>
                                        <tr>
                                            <th>Pos</th>
                                            <th>CPA</th>
                                            <th>Remoções</th>
                                            <th>Vias</th>
                                            <th>Eficiência</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;
            
            cpaSorted.slice(0, 8).forEach(([cpa, data], index) => {
                const efficiency = data.vias > 0 ? (data.remocoes / data.vias).toFixed(2) : 0;
                page2 += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${cpa.length > 20 ? cpa.substring(0, 20) + '...' : cpa}</td>
                        <td>${data.remocoes.toFixed(0)}</td>
                        <td>${data.vias.toFixed(0)}</td>
                        <td style="color: ${efficiency > 1.2 ? '#28a745' : efficiency > 0.8 ? '#ffc107' : '#dc3545'}; font-weight: bold;">
                            ${efficiency}
                        </td>
                    </tr>
                `;
            });
            
            page2 += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div>
                            <div class="pdf-ranking">
                                <h3><i class="fas fa-list-ol"></i> Ranking de Áreas</h3>
                                <table class="pdf-table">
                                    <thead>
                                        <tr>
                                            <th>Pos</th>
                                            <th>Área</th>
                                            <th>Remoções</th>
                                            <th>Vias</th>
                                            <th>Peso (T)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;
            
            areaSorted.slice(0, 10).forEach(([area, data], index) => {
                page2 += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${area.length > 25 ? area.substring(0, 25) + '...' : area}</td>
                        <td>${data.remocoes.toFixed(0)}</td>
                        <td>${data.vias.toFixed(0)}</td>
                        <td>${data.peso.toFixed(1)}</td>
                    </tr>
                `;
            });
            
            page2 += `
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="pdf-ranking" style="margin-top: 30px;">
                                <h3><i class="fas fa-chart-pie"></i> Distribuição por CPA</h3>
                                <div style="display: flex; align-items: center; margin-top: 20px;">
                                    <div style="flex: 1; padding-right: 20px;">
            `;
            
            cpaSorted.slice(0, 5).forEach(([cpa, data], index) => {
                const percentage = (data.remocoes / totals.remocoes * 100).toFixed(1);
                page2 += `
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 0.9rem;">${index + 1}. ${cpa.length > 15 ? cpa.substring(0, 15) + '...' : cpa}</span>
                            <span style="font-weight: bold;">${percentage}%</span>
                        </div>
                        <div style="height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${percentage}%; background: linear-gradient(90deg, #667eea, #764ba2);"></div>
                        </div>
                    </div>
                `;
            });
            
            page2 += `
                                    </div>
                                    <div style="width: 120px; height: 120px; border-radius: 50%; background: conic-gradient(
                                        #667eea 0% ${(cpaSorted[0] ? (cpaSorted[0][1].remocoes / totals.remocoes * 100) : 0)}%,
                                        #764ba2 ${(cpaSorted[0] ? (cpaSorted[0][1].remocoes / totals.remocoes * 100) : 0)}% ${(cpaSorted[0] ? (cpaSorted[0][1].remocoes / totals.remocoes * 100) : 0) + (cpaSorted[1] ? (cpaSorted[1][1].remocoes / totals.remocoes * 100) : 0)}%,
                                        #9d50bb ${(cpaSorted[0] ? (cpaSorted[0][1].remocoes / totals.remocoes * 100) : 0) + (cpaSorted[1] ? (cpaSorted[1][1].remocoes / totals.remocoes * 100) : 0)}% ${(cpaSorted[0] ? (cpaSorted[0][1].remocoes / totals.remocoes * 100) : 0) + (cpaSorted[1] ? (cpaSorted[1][1].remocoes / totals.remocoes * 100) : 0) + (cpaSorted[2] ? (cpaSorted[2][1].remocoes / totals.remocoes * 100) : 0)}%,
                                        #2193b0 ${(cpaSorted[0] ? (cpaSorted[0][1].remocoes / totals.remocoes * 100) : 0) + (cpaSorted[1] ? (cpaSorted[1][1].remocoes / totals.remocoes * 100) : 0) + (cpaSorted[2] ? (cpaSorted[2][1].remocoes / totals.remocoes * 100) : 0)}% 100%
                                    );"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                                        
                    <div class="pdf-footer">
                        Página 2 de 4 | Relatório gerado em ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}
                    </div>
                </div>
            `;
            
            // Página 3: Dados por Município
            const municipioSorted = Object.entries(municipioAggregates).sort((a, b) => b[1].remocoes - a[1].remocoes);
            
            let page3 = `
                <div class="pdf-page landscape">
                    <div class="pdf-header">
                        <h2>Análise por Município</h2>
                        <p>Desempenho detalhado por município atendido</p>
                    </div>
                    
                    <div class="pdf-ranking">
                        <h3><i class="fas fa-city"></i> Top 10 Municípios por Remoções</h3>
                        <table class="pdf-table">
                            <thead>
                                <tr>
                                    <th>Pos</th>
                                    <th>Município</th>
                                    <th>CPA</th>
                                    <th>Remoções</th>
                                    <th>Vias</th>
                                    <th>Peso (T)</th>
                                    <th>Localidades</th>
                                    <th>Eficiência</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            municipioSorted.slice(0, 15).forEach(([municipio, data], index) => {
                const efficiency = data.vias > 0 ? (data.remocoes / data.vias).toFixed(2) : 0;
                page3 += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${municipio.length > 20 ? municipio.substring(0, 20) + '...' : municipio}</td>
                        <td>${data.cpa.length > 10 ? data.cpa.substring(0, 10) + '...' : data.cpa}</td>
                        <td>${data.remocoes.toFixed(0)}</td>
                        <td>${data.vias.toFixed(0)}</td>
                        <td>${data.peso.toFixed(1)}</td>
                        <td>${data.localidadesCount || 0}</td>
                        <td style="color: ${efficiency > 1.2 ? '#28a745' : efficiency > 0.8 ? '#ffc107' : '#dc3545'}; font-weight: bold;">
                            ${efficiency}
                        </td>
                    </tr>
                `;
            });
            
            page3 += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                        <div class="pdf-ranking">
                            <h3><i class="fas fa-map-marked-alt"></i> Cobertura Geográfica</h3>
                            <div style="margin-top: 20px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Municípios com mais de 10 remoções:</span>
                                    <span style="font-weight: bold;">${municipioSorted.filter(([_, data]) => data.remocoes > 10).length}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Municípios com mais de 5 vias desobstruídas:</span>
                                    <span style="font-weight: bold;">${municipioSorted.filter(([_, data]) => data.vias > 5).length}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Municípios com mais de 3 localidades visitadas:</span>
                                    <span style="font-weight: bold;">${municipioSorted.filter(([_, data]) => data.localidadesCount > 3).length}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Municípios atendidos por múltiplas áreas/equipes:</span>
                                    <span style="font-weight: bold;">${new Set(municipioSorted.filter(([_, data]) => data.area).map(([_, data]) => data.area)).size}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pdf-ranking">
                            <h3><i class="fas fa-chart-bar"></i> Distribuição de Desempenho</h3>
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Alta Eficiência (E > 1.2):</span>
                                        <span style="font-weight: bold;">${municipioSorted.filter(([_, data]) => (data.vias > 0 ? data.remocoes / data.vias : 0) > 1.2).length}</span>
                                    </div>
                                    <div style="height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden;">
                                        <div style="height: 100%; width: ${(municipioSorted.filter(([_, data]) => (data.vias > 0 ? data.remocoes / data.vias : 0) > 1.2).length / municipioSorted.length * 100)}%; background: #28a745;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Média Eficiência (0.8 < E ≤ 1.2):</span>
                                        <span style="font-weight: bold;">${municipioSorted.filter(([_, data]) => (data.vias > 0 ? data.remocoes / data.vias : 0) > 0.8 && (data.vias > 0 ? data.remocoes / data.vias : 0) <= 1.2).length}</span>
                                    </div>
                                    <div style="height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden;">
                                        <div style="height: 100%; width: ${(municipioSorted.filter(([_, data]) => (data.vias > 0 ? data.remocoes / data.vias : 0) > 0.8 && (data.vias > 0 ? data.remocoes / data.vias : 0) <= 1.2).length / municipioSorted.length * 100)}%; background: #ffc107;"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Baixa Eficiência (E ≤ 0.8):</span>
                                        <span style="font-weight: bold;">${municipioSorted.filter(([_, data]) => (data.vias > 0 ? data.remocoes / data.vias : 0) <= 0.8).length}</span>
                                    </div>
                                    <div style="height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden;">
                                        <div style="height: 100%; width: ${(municipioSorted.filter(([_, data]) => (data.vias > 0 ? data.remocoes / data.vias : 0) <= 0.8).length / municipioSorted.length * 100)}%; background: #dc3545;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                                      
                    <div class="pdf-footer">
                        Página 3 de 4 | Relatório gerado em ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}
                    </div>
                </div>
            `;
            
            // Página 4: Conclusões e Insights
            const totalMunicipios = Object.keys(municipioAggregates).length;
            const avgRemocoesPorMunicipio = totalMunicipios > 0 ? totals.remocoes / totalMunicipios : 0;
            const eficienciaGeral = totals.vias > 0 ? (totals.remocoes / totals.vias).toFixed(2) : 0;
            
            let page4 = `
                <div class="pdf-page landscape">
                    <div class="pdf-header">
                        <h2>Conclusões e Recomendações</h2>
                        <p>Análise final e direcionamentos estratégicos</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                        <div>
                            <div class="pdf-ranking">
                                <h3><i class="fas fa-lightbulb"></i> Insights Principais</h3>
                                <div style="margin-top: 20px;">
                                    <div style="padding: 15px; background: ${totals.remocoes > 1000 ? '#d4edda' : totals.remocoes > 500 ? '#fff3cd' : '#f8d7da'}; border-left: 4px solid ${totals.remocoes > 1000 ? '#28a745' : totals.remocoes > 500 ? '#ffc107' : '#dc3545'}; margin-bottom: 15px; border-radius: 0 8px 8px 0;">
                                        <h4 style="margin: 0 0 10px 0; color: ${totals.remocoes > 1000 ? '#155724' : totals.remocoes > 500 ? '#856404' : '#721c24'};">Desempenho Geral</h4>
                                        <p style="margin: 0; color: ${totals.remocoes > 1000 ? '#155724' : totals.remocoes > 500 ? '#856404' : '#721c24'};">${totals.remocoes > 1000 ? 'Operação altamente eficiente com mais de 1.000 remoções' : totals.remocoes > 500 ? 'Bom desempenho geral da operação' : 'Há espaço para melhorias na eficiência das remoções'}</p>
                                    </div>
                                    
                                    <div style="padding: 15px; background: ${eficienciaGeral > 1 ? '#d4edda' : eficienciaGeral > 0.8 ? '#fff3cd' : '#f8d7da'}; border-left: 4px solid ${eficienciaGeral > 1 ? '#28a745' : eficienciaGeral > 0.8 ? '#ffc107' : '#dc3545'}; margin-bottom: 15px; border-radius: 0 8px 8px 0;">
                                        <h4 style="margin: 0 0 10px 0; color: ${eficienciaGeral > 1 ? '#155724' : eficienciaGeral > 0.8 ? '#856404' : '#721c24'};">Eficiência Operacional</h4>
                                        <p style="margin: 0; color: ${eficienciaGeral > 1 ? '#155724' : eficienciaGeral > 0.8 ? '#856404' : '#721c24'};">Razão remoções/vias: ${eficienciaGeral} (${eficienciaGeral > 1 ? 'Excelente' : eficienciaGeral > 0.8 ? 'Adequada' : 'Necessita melhorias'})</p>
                                    </div>
                                    
                                    <div style="padding: 15px; background: ${totalMunicipios > 15 ? '#d4edda' : totalMunicipios > 8 ? '#fff3cd' : '#f8d7da'}; border-left: 4px solid ${totalMunicipios > 15 ? '#28a745' : totalMunicipios > 8 ? '#ffc107' : '#dc3545'}; margin-bottom: 15px; border-radius: 0 8px 8px 0;">
                                        <h4 style="margin: 0 0 10px 0; color: ${totalMunicipios > 15 ? '#155724' : totalMunicipios > 8 ? '#856404' : '#721c24'};">Cobertura Geográfica</h4>
                                        <p style="margin: 0; color: ${totalMunicipios > 15 ? '#155724' : totalMunicipios > 8 ? '#856404' : '#721c24'};">${totalMunicipios} municípios atendidos (${totalMunicipios > 15 ? 'Ampla cobertura' : totalMunicipios > 8 ? 'Cobertura moderada' : 'Cobertura limitada'})</p>
                                    </div>
                                    
                                    <div style="padding: 15px; background: ${avgRemocoesPorMunicipio > 10 ? '#d4edda' : avgRemocoesPorMunicipio > 5 ? '#fff3cd' : '#f8d7da'}; border-left: 4px solid ${avgRemocoesPorMunicipio > 10 ? '#28a745' : avgRemocoesPorMunicipio > 5 ? '#ffc107' : '#dc3545'}; border-radius: 0 8px 8px 0;">
                                        <h4 style="margin: 0 0 10px 0; color: ${avgRemocoesPorMunicipio > 10 ? '#155724' : avgRemocoesPorMunicipio > 5 ? '#856404' : '#721c24'};">Intensidade por Município</h4>
                                        <p style="margin: 0; color: ${avgRemocoesPorMunicipio > 10 ? '#155724' : avgRemocoesPorMunicipio > 5 ? '#856404' : '#721c24'};">Média de ${avgRemocoesPorMunicipio.toFixed(1)} remoções por município</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="pdf-ranking">
                                <h3><i class="fas fa-bullseye"></i> Recomendações Estratégicas</h3>
                                <div style="margin-top: 20px;">
                                    <div style="display: flex; align-items: start; margin-bottom: 20px;">
                                        <div style="background: #667eea; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0;">1</div>
                                        <div>
                                            <h4 style="margin: 0 0 5px 0; color: #333;">Replicar Estratégias dos Top Performers</h4>
                                            <p style="margin: 0; color: #555; font-size: 0.9rem;">Analisar e implementar as práticas dos CPAs ${cpaSorted[0] ? cpaSorted[0][0] : ''}, ${cpaSorted[1] ? cpaSorted[1][0] : ''} e ${cpaSorted[2] ? cpaSorted[2][0] : ''} em outras áreas.</p>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; align-items: start; margin-bottom: 20px;">
                                        <div style="background: #667eea; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0;">2</div>
                                        <div>
                                            <h4 style="margin: 0 0 5px 0; color: #333;">Otimizar Alocação de Recursos</h4>
                                            <p style="margin: 0; color: #555; font-size: 0.9rem;">Direcionar mais recursos para municípios com baixa eficiência (E ≤ 0.8) para melhorar resultados.</p>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; align-items: start; margin-bottom: 20px;">
                                        <div style="background: #667eea; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0;">3</div>
                                        <div>
                                            <h4 style="margin: 0 0 5px 0; color: #333;">Expandir Cobertura Territorial</h4>
                                            <p style="margin: 0; color: #555; font-size: 0.9rem;">Identificar e atender municípios ainda não cobertos pela operação, especialmente em áreas com histórico de barricadas.</p>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; align-items: start;">
                                        <div style="background: #667eea; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0;">4</div>
                                        <div>
                                            <h4 style="margin: 0 0 5px 0; color: #333;">Implementar Monitoramento Contínuo</h4>
                                            <p style="margin: 0; color: #555; font-size: 0.9rem;">Criar sistema de acompanhamento em tempo real para tomada de decisão ágil baseada em dados.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 40px; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 10px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.3rem;">Relatório Finalizado</h3>
                        <p style="margin: 0; opacity: 0.9;">Operação Barricada Zero - ${new Date().getFullYear()}</p>
                        <p style="margin: 10px 0 0 0; font-size: 0.9rem; opacity: 0.8;">Este relatório foi gerado automaticamente pelo sistema de análise de dados.</p>
                    </div>
                                        
                    <div class="pdf-footer">
                        Página 4 de 4 | Relatório gerado em ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}
                    </div>
                </div>
            `;
            
            previewDiv.innerHTML = page1 + page2 + page3 + page4;
            pdfPreviewGenerated = true;
        }

        async function downloadPDF() {
            showLoading(true);
            
            try {
                // Obter o elemento que contém as páginas do PDF
                const pdfPreview = document.getElementById('pdfPreview');
                if (!pdfPreview) {
                    throw new Error('Elemento de pré-visualização não encontrado.');
                }
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Obter todas as páginas dentro do preview
                const pages = pdfPreview.querySelectorAll('.pdf-page');
                
                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];
                    
                    // Configurar o html2canvas para capturar a página
                    const canvas = await html2canvas(page, {
                        scale: 2, // Maior qualidade
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: page.offsetWidth,
                        height: page.offsetHeight,
                        windowWidth: page.offsetWidth,
                        windowHeight: page.offsetHeight
                    });
                    
                    // Adicionar nova página se não for a primeira
                    if (i > 0) {
                        pdf.addPage();
                    }
                    
                    // Converter canvas para imagem e adicionar ao PDF
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    // Calcular dimensões para manter proporção
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                    const width = imgWidth * ratio;
                    const height = imgHeight * ratio;
                    
                    // Adicionar imagem ao PDF
                    pdf.addImage(imgData, 'JPEG', 
                        (pdfWidth - width) / 2, // Centralizar horizontalmente
                        (pdfHeight - height) / 2, // Centralizar verticalmente
                        width, height);
                }
                
                // Salvar o PDF
                pdf.save(`Operacao_Barricada_Zero_${new Date().toISOString().slice(0,10)}.pdf`);
                
                showLoading(false);
                closePDFModal();
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF. Por favor, tente novamente.');
                showLoading(false);
            }
        }

        function generatePPTX() {
            try {
                showLoading(true);
                
                const pptx = new PptxGenJS();
                
                pptx.defineLayout({ name: 'CUSTOM', width: 10, height: 5.625 });
                pptx.layout = 'CUSTOM'
                
                const titleStyle = { 
                    fontSize: 28, 
                    bold: true, 
                    color: 'FFFFFF',
                    fontFace: 'Arial'
                };
                
                const subtitleStyle = { 
                    fontSize: 18, 
                    color: 'FFFFFF',
                    fontFace: 'Arial'
                };
                
                const slide1 = pptx.addSlide();
                slide1.background = { color: '667eea' };
                slide1.addText('Operação Barricada Zero', {
                    x: 0.5, y: 1.0, w: 9, h: 1.5,
                    ...titleStyle,
                    align: 'center'
                });
                slide1.addText('Relatório de Desempenho e Análise', {
                    x: 0.5, y: 2.5, w: 9, h: 1.0,
                    ...subtitleStyle,
                    align: 'center'
                });
                slide1.addText('Esta apresentação é um esboço e você pode e deve ajustá-la a seu gosto!', {
                    x: 0.5, y: 3.5, w: 9, h: 0.8,
                    fontSize: 14,
                    color: 'FFFFFF',
                    align: 'center',
                    fontFace: 'Calibri',
                    italic: true
                });
                slide1.addText('Dashboard Interativo - Análise de Dados em Tempo Real', {
                    x: 0.5, y: 4.5, w: 9, h: 1.0,
                    fontSize: 16,
                    color: 'CCCCCC',
                    align: 'center',
                    fontFace: 'Calibri'
                });
                slide1.addText('Gerado em: ' + new Date().toLocaleDateString('pt-BR'), {
                    x: 0.5, y: 6.0, w: 9, h: 0.5,
                    fontSize: 12,
                    color: 'CCCCCC',
                    align: 'center',
                    fontFace: 'Calibri'
                });
                
                const totals = filteredData.reduce((acc, row) => ({
                    remocoes: acc.remocoes + row.REMOCOES,
                    vias: acc.vias + row.VIAS,
                    peso: acc.peso + row.PESO
                }), { remocoes: 0, vias: 0, peso: 0 });
                
                const slide2 = pptx.addSlide();
                slide2.background = { color: 'FFFFFF' };
                slide2.addText('Métricas Principais', {
                    x: 0.5, y: 0.3, w: 9, h: 0.8,
                    fontSize: 24,
                    bold: true,
                    color: '333333',
                    fontFace: 'Arial'
                });
                
                const metrics = [
                    { label: 'Remoções Totais', value: totals.remocoes.toFixed(0), color: 'FF7E5F', icon: '🚧' },
                    { label: 'Vias Liberadas', value: totals.vias.toFixed(0), color: '56AB2F', icon: '🛣️' },
                    { label: 'Peso Total (T)', value: totals.peso.toFixed(2), color: '2193B0', icon: '⚖️' },
                    { label: 'Municípios', value: Object.keys(municipioAggregates).length, color: '9D50BB', icon: '🏙️' }
                ];
                
                metrics.forEach((metric, index) => {
                    const row = Math.floor(index / 2);
                    const col = index % 2;
                    const x = 0.5 + (col * 4.5);
                    const y = 1.5 + (row * 2.2);
                    
                    slide2.addShape(pptx.shapes.ROUNDED_RECTANGLE, {
                        x, y, w: 4.0, h: 1.8,
                        fill: { color: metric.color },
                        line: { color: 'FFFFFF', width: 2 },
                        rectRadius: 0.2
                    });
                    
                    slide2.addText(metric.icon, {
                        x: x + 0.2, y: y + 0.2, w: 0.8, h: 0.8,
                        fontSize: 24,
                        color: 'FFFFFF',
                        fontFace: 'Segoe UI Emoji'
                    });
                    
                    slide2.addText(metric.value, {
                        x: x + 1.0, y: y + 0.3, w: 2.8, h: 0.8,
                        fontSize: 28,
                        bold: true,
                        color: 'FFFFFF',
                        fontFace: 'Arial'
                    });
                    
                    slide2.addText(metric.label, {
                        x: x + 0.2, y: y + 1.2, w: 3.6, h: 0.5,
                        fontSize: 12,
                        color: 'FFFFFF',
                        fontFace: 'Calibri'
                    });
                });
                
                const slide3 = pptx.addSlide();
                slide3.background = { color: 'F8F9FA' };
                slide3.addText('Top Performers', {
                    x: 0.5, y: 0.3, w: 9, h: 0.8,
                    fontSize: 24,
                    bold: true,
                    color: '333333',
                    fontFace: 'Arial'
                });
                
                const topCPA = Object.entries(aggregates.cpa)
                    .sort((a, b) => b[1].remocoes - a[1].remocoes)[0];
                const topArea = Object.entries(aggregates.area)
                    .sort((a, b) => b[1].remocoes - a[1].remocoes)[0];
                const topMunicipio = Object.entries(municipioAggregates)
                    .sort((a, b) => b[1].remocoes - a[1].remocoes)[0];
                
                const performers = [
                    { 
                        title: '🏆 CPA Destaque', 
                        name: topCPA ? topCPA[0] : 'N/A', 
                        value: topCPA ? topCPA[1].remocoes.toFixed(0) : '0',
                        metric: 'Remoções',
                        color: 'FFD700'
                    },
                    { 
                        title: '🥈 Área mais Eficiente', 
                        name: topArea ? topArea[0] : 'N/A', 
                        value: topArea ? topArea[1].remocoes.toFixed(0) : '0',
                        metric: 'Remoções',
                        color: 'C0C0C0'
                    },
                    { 
                        title: '🥉 Município Destaque', 
                        name: topMunicipio ? topMunicipio[0] : 'N/A', 
                        value: topMunicipio ? topMunicipio[1].remocoes.toFixed(0) : '0',
                        metric: 'Remoções',
                        color: 'CD7F32'
                    }
                ];
                
                performers.forEach((performer, index) => {
                    const x = 0.5 + (index * 3.0);
                    if (x > 6.5) return;
                    
                    slide3.addShape(pptx.shapes.ROUNDED_RECTANGLE, {
                        x, y: 1.5, w: 2.8, h: 2.5,
                        fill: { color: performer.color },
                        line: { color: 'FFFFFF', width: 2 },
                        rectRadius: 0.2
                    });
                    
                    slide3.addText(performer.title, {
                        x: x + 0.2, y: 1.7, w: 2.4, h: 0.5,
                        fontSize: 14,
                        bold: true,
                        color: '333333',
                        align: 'center',
                        fontFace: 'Arial'
                    });
                    
                    slide3.addText(performer.name, {
                        x: x + 0.2, y: 2.3, w: 2.4, h: 0.6,
                        fontSize: 16,
                        bold: true,
                        color: 'FFFFFF',
                        align: 'center',
                        fontFace: 'Arial',
                        wrap: true
                    });
                    
                    slide3.addText(performer.value, {
                        x: x + 0.2, y: 3.0, w: 2.4, h: 0.8,
                        fontSize: 28,
                        bold: true,
                        color: 'FFFFFF',
                        align: 'center',
                        fontFace: 'Arial'
                    });
                    
                    slide3.addText(performer.metric, {
                        x: x + 0.2, y: 3.8, w: 2.4, h: 0.3,
                        fontSize: 11,
                        color: '333333',
                        align: 'center',
                        fontFace: 'Calibri'
                    });
                });
                
                const slide4 = pptx.addSlide();
                slide4.background = { color: 'FFFFFF' };
                slide4.addText('Ranking de CPAs', {
                    x: 0.5, y: 0.3, w: 9, h: 0.6,
                    fontSize: 20,
                    bold: true,
                    color: '333333',
                    fontFace: 'Arial'
                });
                
                const cpaSorted = Object.entries(aggregates.cpa)
                    .sort((a, b) => b[1].remocoes - a[1].remocoes);
                
                const cpaTable = [['Pos', 'CPA', 'Remoções', 'Vias', 'Peso (T)']];
                cpaSorted.forEach(([cpa, data], index) => {
                    cpaTable.push([
                        (index + 1).toString(),
                        cpa.length > 20 ? cpa.substring(0, 20) + '...' : cpa,
                        data.remocoes.toFixed(0),
                        data.vias.toFixed(0),
                        data.peso.toFixed(1)
                    ]);
                });
                
                slide4.addTable(cpaTable, {
                    x: 0.5, y: 1.0, w: 9, h: 4.2,
                    colW: [0.6, 3.5, 1.6, 1.6, 1.6],
                    fontSize: 10,
                    color: '333333',
                    fill: { color: 'F8F9FA' },
                    border: { pt: 1, color: 'DDDDDD' },
                    fontFace: 'Calibri',
                    rowH: 0.3
                });
                
                const slide5 = pptx.addSlide();
                slide5.background = { color: 'FFFFFF' };
                slide5.addText('Ranking de Áreas', {
                    x: 0.5, y: 0.3, w: 9, h: 0.6,
                    fontSize: 20,
                    bold: true,
                    color: '333333',
                    fontFace: 'Arial'
                });
                
                const areaSorted = Object.entries(aggregates.area)
                    .sort((a, b) => b[1].remocoes - a[1].remocoes);
                
                const areaTable = [['Pos', 'Área', 'Remoções', 'Vias', 'Peso (T)']];
                areaSorted.forEach(([area, data], index) => {
                    areaTable.push([
                        (index + 1).toString(),
                        area.length > 20 ? area.substring(0, 20) + '...' : area,
                        data.remocoes.toFixed(0),
                        data.vias.toFixed(0),
                        data.peso.toFixed(1)
                    ]);
                });
                
                slide5.addTable(areaTable, {
                    x: 0.5, y: 1.0, w: 9, h: 4.2,
                    colW: [0.6, 3.5, 1.6, 1.6, 1.6],
                    fontSize: 10,
                    color: '333333',
                    fill: { color: 'F8F9FA' },
                    border: { pt: 1, color: 'DDDDDD' },
                    fontFace: 'Calibri',
                    rowH: 0.3
                });
                
                // Slide 6: Ranking de BPMs - Top 10
                const slide6 = pptx.addSlide();
                slide6.background = { color: 'FFFFFF' };
                slide6.addText('Ranking de BPMs - Top 10', {
                    x: 0.5, y: 0.3, w: 9, h: 0.6,
                    fontSize: 20,
                    bold: true,
                    color: '333333',
                    fontFace: 'Arial'
                });
                
                const bpmSorted = Object.values(aggregates.bpm)
                    .sort((a, b) => b.remocoes - a.remocoes)
                    .slice(0, 10);
                
                const bpmTable = [['Pos', 'BPM', 'CPA', 'Área', 'Remoções', 'Vias', 'Peso (T)']];
                bpmSorted.forEach((bpm, index) => {
                    bpmTable.push([
                        (index + 1).toString(),
                        bpm.bpm.length > 15 ? bpm.bpm.substring(0, 15) + '...' : bpm.bpm,
                        bpm.cpa.length > 10 ? bpm.cpa.substring(0, 10) + '...' : bpm.cpa,
                        bpm.area.length > 10 ? bpm.area.substring(0, 10) + '...' : bpm.area,
                        bpm.remocoes.toFixed(0),
                        bpm.vias.toFixed(0),
                        bpm.peso.toFixed(1)
                    ]);
                });
                
                // Adicionar uma linha de rodapé com o total
                bpmTable.push([
                    '',
                    'TOTAL',
                    '',
                    '',
                    bpmSorted.reduce((sum, bpm) => sum + bpm.remocoes, 0).toFixed(0),
                    bpmSorted.reduce((sum, bpm) => sum + bpm.vias, 0).toFixed(0),
                    bpmSorted.reduce((sum, bpm) => sum + bpm.peso, 0).toFixed(1)
                ]);
                
                slide6.addTable(bpmTable, {
                    x: 0.3, y: 1.0, w: 9.4, h: 4.2,
                    colW: [0.6, 2.5, 1.8, 1.8, 1.2, 1.2, 1.2],
                    fontSize: 10,
                    color: '333333',
                    fill: { color: 'F8F9FA' },
                    border: { pt: 1, color: 'DDDDDD' },
                    fontFace: 'Calibri',
                    rowH: 0.35
                });
                
                // Adicionar um gráfico de barras para visualização dos Top 10 BPMs
                if (bpmSorted.length > 0) {
                    const chartData = {
                        labels: bpmSorted.map(bpm => bpm.bpm.length > 10 ? bpm.bpm.substring(0, 10) + '...' : bpm.bpm),
                        datasets: [{
                            label: 'Remoções',
                            data: bpmSorted.map(bpm => bpm.remocoes),
                            backgroundColor: 'rgba(102, 126, 234, 0.7)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        }]
                    };
                    
                    // Adicionar um gráfico simples
                    const maxValue = Math.max(...bpmSorted.map(bpm => bpm.remocoes));
                    const barHeight = 0.25;
                    const barSpacing = 0.3;
                    const startY = 5.5;
                    
                    bpmSorted.forEach((bpm, index) => {
                        const barWidth = (bpm.remocoes / maxValue) * 6;
                        const yPos = startY + (index * barSpacing);
                        
                        // Barra
                        slide6.addShape(pptx.shapes.RECTANGLE, {
                            x: 1.0, y: yPos, w: barWidth, h: barHeight,
                            fill: { color: '667eea' },
                            line: { color: '667eea', width: 1 }
                        });
                        
                        // Label do BPM
                        slide6.addText(bpm.bpm.length > 12 ? bpm.bpm.substring(0, 12) + '...' : bpm.bpm, {
                            x: 0.3, y: yPos, w: 1.5, h: barHeight,
                            fontSize: 8,
                            color: '333333',
                            fontFace: 'Calibri'
                        });
                        
                        // Valor
                        slide6.addText(bpm.remocoes.toFixed(0), {
                            x: 1.0 + barWidth + 0.1, y: yPos, w: 1.0, h: barHeight,
                            fontSize: 8,
                            color: '333333',
                            fontFace: 'Calibri'
                        });
                    });
                    
                    // Título do gráfico
                    slide6.addText('Visualização das Remoções - Top 10 BPMs', {
                        x: 0.3, y: 5.0, w: 9.0, h: 0.5,
                        fontSize: 12,
                        bold: true,
                        color: '333333',
                        fontFace: 'Arial'
                    });
                    
                    // Legenda
                    slide6.addText('Fonte: Operação Barricada Zero | Dados processados em ' + new Date().toLocaleDateString('pt-BR'), {
                        x: 0.3, y: 8.5, w: 9.0, h: 0.3,
                        fontSize: 7,
                        color: '666666',
                        fontFace: 'Calibri'
                    });
                }
                
                const slide7 = pptx.addSlide();
                slide7.background = { color: 'FFFFFF' };
                slide7.addText('Análise por Município', {
                    x: 0.5, y: 0.3, w: 9, h: 0.6,
                    fontSize: 20,
                    bold: true,
                    color: '333333',
                    fontFace: 'Arial'
                });
                
                const municipioSorted = Object.entries(municipioAggregates)
                    .sort((a, b) => b[1].remocoes - a[1].remocoes);
                
                const municipioTable = [['Pos', 'Município', 'CPA', 'Remoções', 'Vias', 'Peso', 'Local.']];
                municipioSorted.forEach(([municipio, data], index) => {
                    municipioTable.push([
                        (index + 1).toString(),
                        municipio.length > 15 ? municipio.substring(0, 15) + '...' : municipio,
                        data.cpa.length > 10 ? data.cpa.substring(0, 10) + '...' : data.cpa,
                        data.remocoes.toFixed(0),
                        data.vias.toFixed(0),
                        data.peso.toFixed(1),
                        (data.localidadesCount || 0).toString()
                    ]);
                });
                
                slide7.addTable(municipioTable, {
                    x: 0.3, y: 1.0, w: 9.4, h: 4.2,
                    colW: [0.5, 2.2, 1.5, 1.3, 1.3, 1.3, 0.8],
                    fontSize: 8,
                    color: '333333',
                    fill: { color: 'F8F9FA' },
                    border: { pt: 1, color: 'DDDDDD' },
                    fontFace: 'Calibri',
                    rowH: 0.25
                });
                
                const slide8 = pptx.addSlide();
                slide8.background = { color: 'F0F8FF' };
                slide8.addText('Insights e Recomendações', {
                    x: 0.5, y: 0.3, w: 9, h: 0.8,
                    fontSize: 24,
                    bold: true,
                    color: '333333',
                    fontFace: 'Arial'
                });
                
                const totalRemocoes = totals.remocoes;
                const totalMunicipios = Object.keys(municipioAggregates).length;
                const avgRemocoesPorMunicipio = totalMunicipios > 0 ? totalRemocoes / totalMunicipios : 0;
                
                let insights = [];
                
                if (totalRemocoes > 1000) {
                    insights.push('✅ Operação altamente eficiente com mais de 1.000 remoções');
                } else if (totalRemocoes > 500) {
                    insights.push('✅ Bom desempenho geral da operação');
                } else {
                    insights.push('⚠️ Há espaço para melhorias na eficiência das remoções');
                }
                
                if (avgRemocoesPorMunicipio > 10) {
                    insights.push('✅ Alta concentração de remoções por município');
                }
                
                if (totals.vias / totals.remocoes > 0.8) {
                    insights.push('✅ Excelente relação vias/remoções (eficiência alta)');
                } else {
                    insights.push('⚠️ Considerar estratégias para aumentar vias liberadas por remoção');
                }
                
                if (Object.keys(municipioAggregates).length > 15) {
                    insights.push('✅ Amplo alcance territorial com boa cobertura');
                }
                
                // Layout de duas colunas para melhor distribuição
                insights.forEach((insight, index) => {
                    const col = index < 3 ? 0.8 : 4.8;
                    const row = index < 3 ? 1.5 + (index * 0.6) : 1.5 + ((index-3) * 0.6);
                    
                    slide8.addText(insight, {
                        x: col, y: row, w: 4.0, h: 0.4,
                        fontSize: 11,
                        color: '333333',
                        fontFace: 'Calibri',
                        wrap: true
                    });
                });
                
                slide8.addText('Recomendações Estratégicas:', {
                    x: 0.5, y: 3.8, w: 9, h: 0.6,
                    fontSize: 18,
                    bold: true,
                    color: '333333',
                    fontFace: 'Arial'
                });
                
                const recommendations = [
                    '1. 📊 Replicar estratégias dos CPAs top performers em outras áreas',
                    '2. 🗺️ Expandir operações para municípios com baixa cobertura',
                    '3. 🚚 Otimizar logística para maior eficiência no transporte',
                    '4. 📱 Implementar sistema de monitoramento em tempo real'
                ];
                
                recommendations.forEach((rec, index) => {
                    const col = index < 2 ? 0.8 : 4.8;
                    const row = index < 2 ? 4.5 + (index * 0.5) : 4.5 + ((index-2) * 0.5);
                    
                    slide8.addText(rec, {
                        x: col, y: row, w: 4.0, h: 0.4,
                        fontSize: 11,
                        color: '555555',
                        fontFace: 'Calibri',
                        wrap: true
                    });
                });
                
                setTimeout(() => {
                    pptx.writeFile({ fileName: `Operacao_Barricada_Zero_${new Date().toISOString().slice(0,10)}.pptx` })
                        .then(() => {
                            showLoading(false);
                            alert('Apresentação PPTX gerada com sucesso!');
                        })
                        .catch(err => {
                            showLoading(false);
                            alert('Erro ao gerar PPTX: ' + err.message);
                        });
                }, 100);
                    
            } catch (err) {
                showLoading(false);
                alert('Erro ao gerar PPTX: ' + err.message);
                console.error(err);
            }
        }

        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
